---
title: "DHS comparison"
output: html_notebook
---

I copied this over from a .R file on Nov 17, 2016 and simplified some of the code. Since we're only interested in DHS by tenax and DCSE by twister, I've deleted quite a bit of code.

```{r, include=FALSE}
setwd("/Users/scottericr/Google Drive/R Code/Twister Data")
library(reshape2)
library(tidyr)
library(dplyr)
library(venn)
library(ggplot2)
library(readr)
library(xlsx)
source("/Users/scottericr/Google Drive/R Code/myfunctions.R")
```
#Importing the data

```{r}
input <- read_csv("DHS Comparison updated.csv") #Nicole added back two compounds she previously removed as contaminants.  They're not actually contaminants.

input2 <- input[1:12, ]
#glimpse(input2)

input2[is.na(input2)] <- 0  #NA's represent 0's


#Read in annotated library for later extraction of LogKOW and vapor pressure
library <- read_csv("annotated library mar 13 2017.csv")

```

create treatment variables
```{r}
vars <- colsplit(input2$Treatment, "\\.", c("Method", "Treatment", "Rep"))
vars

len <- dim(input2)[2]
data <- cbind(vars$Method, vars$Treatment, input2[ , 2:len])
colnames(data)[1:2] <- c("Method","Treatment")
head(data)
#glimpse(data)
```

find any compounds that are constants
```{r}
counts<-head(summarise_each(data, funs(n_distinct)))
rm <- which(counts <= 1)
rm
data <- subset(data, select = -rm)
#glimpse(data)
```

## With only DHS Tenax vs. DCSE Twister
```{r}
t(data[ , 3:length(data)]) %>% as.data.frame() -> x

colnames(x) <- input2$Treatment

x.data <- transmute(x, DHS.Tenax = Tenax.Cont.1 + Tenax.Cont.2 + Tenax.Cont.3 + 
                       Tenax.MeJA.1 + Tenax.MeJA.2 + Tenax.MeJA.3, 
                     DCSE.Twister = Twister.Cont.1 + Twister.Cont.2 + Twister.Cont.3 + 
                       Twister.MeJA.1 + Twister.MeJA.2 + Twister.MeJA.3)


x.data$Compound <- rownames(x)
x.data <- dplyr::select(x.data, Compound, everything())

x.logical <- x.data
x.logical[x.data > 0] = 1
tail(x.logical)
venn(x.logical[ , -1], cexil = 1, cexsn = .85)

DHS.Tenax.unique <- subset(x.data, x.data$DHS.Tenax != 0 & x.data$DCSE.Twister == 0)
dim(DHS.Tenax.unique)[1]

DCSE.Twister.unique <- subset(x.data, x.data$DCSE.Twister !=0 & x.data$DHS.Tenax == 0)
dim(DCSE.Twister.unique)[1]

rbind(DHS.Tenax.unique, DCSE.Twister.unique) -> method_unique_compounds

left_join(method_unique_compounds, library, by = c("Compound" = "IA_Name")) %>% select(Compound, DHS.Tenax, DCSE.Twister, Log_P, LogP_Type, Vapor_Pressure, Vapor_Pressure_At) -> method_unique_compounds

colSums(x.logical[ , -1])
```
A total of `colSums(x.logical[ , -1])[1]` compounds were detected by DHS and `colSums(x.logical[ , -1])[2]` compounds were detected by DCSE.  `dim(DHS.Tenax.unique)[1]` of these compounds were unique to DHS sampling and `dim(DCSE.Twister.unique)[1]` were unique to DCSE.

##By treatment
```{r}
x.trt.data <- transmute(x, Control = Tenax.Cont.1 + Tenax.Cont.2 + Tenax.Cont.3 + 
                       Twister.Cont.1 + Twister.Cont.2 + Twister.Cont.3,
                      MeJA = Tenax.MeJA.1 + Tenax.MeJA.2 + Tenax.MeJA.3 + 
                       Twister.MeJA.1 + Twister.MeJA.2 + Twister.MeJA.3)

#head(x.treatment)

x.trt.data$Compound <- rownames(x)
x.trt.data <- dplyr::select(x.trt.data, Compound, everything())

x.trt.logical <- x.trt.data
x.trt.logical[x.trt.logical>0] = 1

Control.unique <- subset(x.trt.data, x.trt.data$Control != 0 & x.trt.data$MeJA == 0)
dim(Control.unique)[1]

MeJA.unique <- subset(x.trt.data, x.trt.data$Control == 0 & x.trt.data$MeJA != 0)
dim(MeJA.unique)[1]

treatment_unique_compounds <- rbind(Control.unique, MeJA.unique)

left_join(treatment_unique_compounds, library, by = c("Compound" = "IA_Name")) %>% select(Compound, Control, MeJA, Log_P, LogP_Type, Vapor_Pressure, Vapor_Pressure_At) -> treatment_unique_compounds

colSums(x.trt.logical[ , -1])
```
`colSums(x.trt.logical[ , -1])[1]` compounds in Control, `colSums(x.trt.logical[ , -1])[2]` found in MeJA treated plants.  `dim(Control.unique)[1]` compounds are unique to Control plants and `dim(MeJA.unique)[1]` compounds are unique to MeJA treated plants.


##By treatment AND method
```{r}
x.both.logical <- transmute(x, Control.DHS = Tenax.Cont.1 + Tenax.Cont.2 + Tenax.Cont.3,
                              Control.DCSE = Twister.Cont.1 + Twister.Cont.2 + Twister.Cont.3,
                              MeJA.DHS = Tenax.MeJA.1 + Tenax.MeJA.2 + Tenax.MeJA.3, 
                              MeJA.DCSE = Twister.MeJA.1 + Twister.MeJA.2 + Twister.MeJA.3)

#head(x.treatment)
x.both.logical[x.both.logical > 0] = 1
x.both.logical$Compound <- rownames(x)
x.both.logical <- dplyr::select(x.both.logical, Compound, everything())

colSums(x.both.logical[ , -1])
```

## Write to a file
```{r}
write.xlsx(method_unique_compounds, "unique compounds.xlsx", sheetName = "By Method", row.names = FALSE)
write.xlsx(treatment_unique_compounds, "unique compounds.xlsx", sheetName = "By Treatment", row.names = FALSE, append = TRUE)
```

#PCA
I conduct a PCA and plot PC1 vs PC2
```{r}
data.scaled <- scale(data[3:length(data)])
all.pca <- prcomp(data.scaled, scale. = FALSE, center = FALSE)
summary(all.pca)
#4 PCs to capture ~80% of variance
#screeplot(all.pca,type="l")
```
80% of variation captured in ~4 PCs

## PCA Plot
```{r plot theme}
##my ggplot2 theme
multivar.theme <- theme_bw(base_size = 10, base_family = "Arial")+  #this changes the default text size and font
  theme(axis.title = element_text(size = 10),                      #this sets a different font size for the axis labels
        panel.border = element_rect(size = 1, color = "black"),   #change size= here to change border size
        panel.grid.major = element_blank(),                     #these two lines make the grid lines go away
        panel.grid.minor = element_blank())

```

```{r}
Method <- data$Method
Treatment <- data$Treatment
shape.labels = c("DHS", "DCSE")
col.labels = c("Control", "MeJA")
cols<-c("Cont" = "#1b9e77", "MeJA" = "#d95f02")
ggplot(as.data.frame(all.pca$x), aes(PC1, PC2)) + 
  geom_point(aes(fill = Treatment, shape = Method), stroke = .5, size = I(3)) + 
  xlim(-18, 18)+
  multivar.theme + 
  scale_shape_manual(values = c(21, 24), 
                     labels = shape.labels) +
  scale_fill_manual(values = cols, 
                    labels = col.labels) +
  guides(fill = guide_legend(override.aes = list(color = cols))) +
  theme(legend.position = "right", legend.box = "vertical") +
  theme(legend.text = element_text(size = 10), 
        legend.title = element_text(size = 10),
        legend.background = element_rect(color = "black")) +
  ylab(paste0("PC2 (",round(summary(all.pca)$importance[2,2]*100, 2), "%)")) + 
  xlab(paste0("PC1 (",round(summary(all.pca)$importance[2,1]*100, 2), "%)"))
#ggsave("Comparison PCA.png", width = 5, height = 3.5, units = "in")
```


#Correlations
Need to figure out which variables (chemicals) correlate with PC1 and PC2.  I get this using a function I wrote in myfunctions.R, but I also add on columns for r^2 values and FDR corrected p-values for the correlation between RPA and PC score for each PC.



```{r}
pca.correlations<-PC.cors(all.pca, as.data.frame(data.scaled), 2)
pca.correlations$PC1.r2 <- pca.correlations$PC1.corr.coefs^2
pca.correlations$PC2.r2 <- pca.correlations$PC2.corr.coefs^2
pca.correlations$PC1.p.corrected <- pca.correlations$PC1.p.values %>% p.adjust(method="fdr")
pca.correlations$PC2.p.corrected <- pca.correlations$PC2.p.values %>% p.adjust(method="fdr")

PC1.corr.sig <- pca.correlations %>% subset(PC1.p.corrected <= 0.05 & PC1.r2 >= 0.8, 
                                            select = c(.Variables, PC1.corr.coefs, PC1.r2,
                                                       PC1.p.corrected))
PC2.corr.sig <- pca.correlations %>% subset(PC2.p.corrected <= 0.05 & PC2.r2 >= 0.8,
                                            select = c(.Variables, PC2.corr.coefs, PC2.r2,
                                                       PC2.p.corrected))
PC1.corr.sig[,-1] <- PC1.corr.sig[,-1] %>% signif(digits=3)
PC1.corr.sig
PC2.corr.sig[,-1] <- PC2.corr.sig[,-1] %>% signif(digits=3)
PC2.corr.sig

#get vapor pressures for these babies

left_join(PC1.corr.sig, library, by = c(".Variables" = "IA_Name")) %>% select(Compound = .Variables, PC1.corr.coefs, PC1.r2, PC1.p.corrected, Log_P, LogP_Type, Vapor_Pressure, Vapor_Pressure_At) -> PC1.corr.sig

left_join(PC2.corr.sig, library, by = c(".Variables" = "IA_Name")) %>% select(Compound = .Variables, PC2.corr.coefs, PC2.r2, PC2.p.corrected, Log_P, LogP_Type, Vapor_Pressure, Vapor_Pressure_At) -> PC2.corr.sig

write.xlsx(PC1.corr.sig, "Comparison PCA compounds.xlsx", sheetName = "PC1", col.names = TRUE, row.names = FALSE)
write.xlsx(PC2.corr.sig, "Comparison PCA compounds.xlsx", sheetName = "PC2", col.names = TRUE, row.names = FALSE, append = TRUE)
```

An alternative method might be to use FDR corrected t-tests since it is very clear that PC1 separates the methods and PC2 separates the treatments

```{r}

important.PC1.data <- select(data, one_of(as.character(PC1.corr.sig$.Variables)))

sig.tests.PC1 <- vector(mode = "numeric", length = length(important.PC1.data))
for(i in 1:length(important.PC1.data)){
  test <- t.test(important.PC1.data[[i]] ~ data$Method)
  sig.tests.PC1[i] <- test$p.value
}

important.PC2.data <- select(data, one_of(as.character(PC2.corr.sig$.Variables)))

sig.tests.PC2 <- vector(mode = "numeric", length = length(important.PC2.data))
for(i in 1:length(important.PC2.data)){
  test <- t.test(important.PC2.data[[i]] ~ data$Treatment)
  sig.tests.PC2[i] <- test$p.value
}
```
The only thing this changes is it takes Benzyl Alcohol off the list for PC2
